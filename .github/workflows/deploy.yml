name: Deploy DocsCrawller Backend

on:
  push:
    branches: ["azureProd"]

jobs:
  deploy:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout Repo
      # This is only for metadata â€” deployment happens on VM
        uses: actions/checkout@v4

      - name: Deploy & Restart Backend via PM2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e

            APP_DIR="/home/azureuser/projects/Docs-Crawleer-Backend"
            VENV="$APP_DIR/venv"
            PM2_NAME="docscrawaller-backend"
            BRANCH="azureProd"

            echo ">>> Switching to project directory"
            cd $APP_DIR

            echo ">>> Fetching latest code"
            git fetch origin
            git checkout $BRANCH
            git pull origin $BRANCH

            echo ">>> Creating venv if missing"
            if [ ! -d "$VENV" ]; then
              python3 -m venv $VENV
            fi

            echo ">>> Activating venv"
            source $VENV/bin/activate

            echo ">>> Upgrading pip"
            pip install --upgrade pip

            echo ">>> Installing dependencies"
            pip install -r requirements.txt

            echo ">>> Running DB migrations if any (optional)"
            # python manage.py migrate
            # alembic upgrade head

            echo ">>> Restarting app using PM2"
            pm2 describe "$PM2_NAME" > /dev/null 2>&1 && PM2_EXISTS=true || PM2_EXISTS=false

            if [ "$PM2_EXISTS" = true ]; then
              pm2 restart "$PM2_NAME"
            else
              pm2 start main.py --name "$PM2_NAME" --interpreter "$VENV/bin/python"
            fi

            echo ">>> Saving PM2 startup config"
            pm2 save

            echo ">>> Deployment complete ğŸ¯"
